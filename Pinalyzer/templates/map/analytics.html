{% extends "base.html" %}

{% block header %}
<link rel="stylesheet" type="text/css" href="/static/css/style_analytics.css"/> 
<script src="static/js/highcharts.js" type="text/javascript"></script>
<script src="static/js/highstock.js" type="text/javascript"></script>
<script src="static/js/modules/exporting.js" type="text/javascript"></script>
<script>
	// Charts
	var rep_chart = null;
	var hist_chart = null;
	var hist_stock = null;
	var user_id=null;
	
	function setNum(x, selector){
		if (x>0){
			c='green';
			num= '+'+x
		}
		else if (x==0){
			c='grey'
			num= '--'
		}
		else{
			c='red'
			num= x
		}
		$(selector).html(num).css('color',c);
	}

	function setRepartitionChart() {
		$.ajax({
			type : 'GET',
			url : 'distribution',
			success : function(res) {
				rep_chart = new Highcharts.Chart({
					chart : {
						renderTo : 'rep-chart',
						type : 'column'
					},
					title : {
						text : 'Distribution'
					},
					xAxis : {
						categories : [ '0-10', '10-20', '20-30', '30-40', '40-50', '50-60', '60-70', '70-80', '80-90', '90-100', ]
					},
					yAxis : {
						min : 0,
						title : {
							text : 'Percent'
						}
					},
					legend : {
						enabled : false,
					},
					tooltip : {
						formatter : function() {
							return '' + this.x + ': ' + this.y + ' %';
						}
					},
					plotOptions : {
						column : {
							pointPadding : 0.2,
							borderWidth : 0
						}
					},
					series : [ {
						name : '',
						data : res.data
					} ]
				});

			},
			dataType : "json"
		});
	}

	function setHistStock(data, name) {

		hist_stock = new Highcharts.StockChart({
			chart : {
				renderTo : 'hist-stock'
			},

			rangeSelector : {
				selected : 1
			},

			title : {
				text : name + "'s score history"
			},

			yAxis : {
				minPadding : 0.05,
				title : {
					text : 'Score'
				},
			},

			series : [ {
				name : 'score',
				data : data,
				marker : {
					enabled : true,
					radius : 3
				},
				shadow : true,
				tooltip : {
					valueDecimals : 2
				}
			} ]
		});
	}

	function setHistChart(data, name) {

		hist_chart = new Highcharts.Chart({
			chart : {
				renderTo : 'hist-chart',
				type : 'spline'
			},
			title : {
				text : 'The last few days'
			},
			xAxis : {
				type : 'datetime',
				dateTimeLabelFormats : { // don't display the dummy year
					month : '%e. %b',
					year : '%b'
				}
			},
			yAxis : {
				minPadding : 0.20,
				title : {
					text : 'Score'
				},
				startOnTick : true,
			},
			tooltip : {
				formatter : function() {
					return '' + this.y + ' %';
				}
			},
			plotOptions : {
				column : {
					pointPadding : 0.2,
					borderWidth : 0
				}
			},
			series : [ {
				name : name,
				data : data
			} ]
		});
	}

	function setUserInfo(user_id) {
		$("#analytics-info").hide();
		$("#score-history,#score-distribution").hide();
		$("#score-disitribution").hide();
		$("#how").hide();
		$("#loading-div").css('visibility', 'visible');
		$("#err").hide();
		$.ajax({
			type : 'POST',
			url : 'scoring',
			data : {
				user_id : user_id,
				fb_id : fb_id,
			},
			success : function(res) {
				if (res.status == "OK") {					
					$("#photo").attr({
						src : res.data.user.photo_url
					});
					$("#name").html(res.data.user.name);
					$("#scorediv>#score-name").html(res.data.user.name + "'s score :")
					$("#location").html(res.data.user.location);
					$("#boards").html(res.data.stat.nb_board);
					$("#pins").html(res.data.stat.nb_pin);
					$("#liked").html(res.data.stat.nb_liked);
					$("#followers").html(res.data.stat.nb_followers);
					$("#following").html(res.data.stat.nb_following);

					if (res.data.prev_stat) {
						score_incr = (res.data.score - res.data.prev_score).toFixed(1)
						boards_incr = res.data.stat.nb_board - res.data.prev_stat.nb_board
						pins_incr = res.data.stat.nb_pin - res.data.prev_stat.nb_pin
						liked_incr = res.data.stat.nb_liked - res.data.prev_stat.nb_liked
						followers_incr = res.data.stat.nb_followers - res.data.prev_stat.nb_followers
						following_incr = res.data.stat.nb_following - res.data.prev_stat.nb_following
					}
					else{
						score_incr = res.data.score.toFixed(1);
                        boards_incr = res.data.stat.nb_board
                        pins_incr = res.data.stat.nb_pin
                        liked_incr = res.data.stat.nb_liked
                        followers_incr = res.data.stat.nb_followers
                        following_incr = res.data.stat.nb_following
                    }
					
					setNum(boards_incr,"#boards-incr");
					setNum(pins_incr,"#pins-incr");
					setNum(liked_incr,"#liked-incr");
					setNum(followers_incr,"#followers-incr");
					setNum(following_incr,"#following-incr");
					
					// if the user is logged
					if(fb_id){
						setNum(score_incr,"#score-incr");
						$("#score").html(res.data.score.toFixed(1));
						setHistStock(res.data.history, res.data.user.name);
						if (rep_chart == null) {
                            setRepartitionChart()
                        }
						$("#score-history").show();
                        $("#score-distribution").show();
                        $('#how').show();
					}
					else{
						setNum(0,"#score-incr");
                        $("#score").html('??');
                        $("#score-history").hide();
                        $("#score-distribution").hide();
                        $('#how').hide();
					}
					$('#analytics-info').show();

				} else {
					$("#err").html(res.data);
					$("#err").show();
				}
				$("#loading-div").css('visibility', 'hidden');
			},
			dataType : "json",
		});
	}

	$(document).ready(function() {
		$("#nav-score").css({
			'background-color' : 'rgb(204,34,37)',
			'color' : 'white'
		});

		// display the score if an user_id is specified in the url
		user = getURIParam(window.location)['user'];
		if (user) {
			user_id=user
			setUserInfo(user_id);
		}
		$('form').submit(function(event) {
			event.preventDefault();
		});

		$('#button').submit(function(event) {
			event.preventDefault();
		});

		$('#button').click(function(event) {
			event.preventDefault();
			user_id = $("#textfield").val();
			setUserInfo(user_id);
		});

		$('#how h2').click(function() {
			$(this).next().slideToggle();
		});

	});
</script>
{% endblock %}

{% block fb %}
FB.Event.subscribe('auth.statusChange',function(response){
        if(response.authResponse){
            fb_id=response.authResponse.userID;
            access_token=response.authResponse.accessToken;
            
        }
        else{
            fb_id=null;
            access_token=null;
        }
        if(user_id != null){
            setUserInfo(user_id);
        }
    });

{% endblock %}

{% block content %}
<h2 id="score-title">Enter your Pinterest id and get your score.</h2>
<div id="input">
	<form>
		<input id="textfield" type="text" name="user_id" /> 
		<input id="button" type="submit" value="Get your score" />
	</form>{% csrf_token %}

</div>

<p id="err"></p>

<div id="loading-div">

	<img src="/static/img/ajax-loader.gif" />
	<p>Please wait, we're computing the score</p>
</div>

<div id="analytics-info">

	<div id="main-info">

		<div id="perso">
			<img id="photo"
				src="http://media-cache-ec7.pinterest.com/upload/25543922857168989_WvVJfZ5c_b.jpg" />
			<div id="nameloc">
				<h2 id="name">Toto</h2>
				<span id="location">Paris</span>
			</div>

		</div>

		<div id="info">



			<table>
				<tr>
					<td id="boards">8</td>
					<td>Boards</td>
				</tr>

				<tr>
					<td id="pins">147</td>
					<td>Pins</td>
				</tr>

				<tr>
					<td id="liked">30</td>
					<td>Likes</td>
				</tr>

				<tr>
					<td id="followers">254</td>
					<td>Followers</td>
				</tr>

				<tr>
					<td id="following">20</td>
					<td>Following</td>
				</tr>
			</table>
		</div>
	</div>

	<div id="scorediv">
		<p id=score-name>Your Pinalyzer score :</p>
		<div>
			<p id="score">??</p>
		</div>
		<div class="login-info init">
		  <p> Want to see your score ?</p>
		  <div class="login-button " id="login-button-score">Login with facebook</div>
		</div>
	</div>

	<div id="activity">
		<h2>Since yesterday...</h2>
        
        <h3> Influence</h3>
		<div class="activity-div">
			<span id="score-incr">--</span><span>Score</span>
		</div>

		<div class="activity-div">
			<span id="followers-incr">--</span><span>Followers</span>
		</div>

		<div class="activity-div">
			<span id="pins-incr">--</span><span>Pins</span>
		</div>

		<div class="activity-div">
			<span id="boards-incr">--</span><span>Boards</span>
		</div>
        
        <h3>Activity</h3>
		<div class="activity-div">
			<span id="following-incr">--</span><span>Following</span>
		</div>

		<div class="activity-div">
			<span id="liked-incr">--</span><span>Likes</span>
		</div>


	</div>

	<div id="score-history">
	   <h2>Score History</h2>
	   <div class="chart" id="hist-stock"></div>
       <div class="chart" id="hist-chart"></div>
	   
	</div>
	
	<div id="score-distribution">
	   <h2>Score distribution for all users</h2>
	   <div class="chart" id="rep-chart"></div>
	</div>

</div>





<div id="how">
	<div>
		<h2>What does the score mean ?</h2>
		<p>The score rates someone's influence and popularity on
			Pinterest. The higher someone's score is, the more influential he or
			she is. The minimum score is 0 and the highest score possible is 100.</p>
	</div>
	<div>
		<h2>How does Pinalyzer compute my score ?</h2>
		<p>Pinalyzer evaluates how people are interested in your pins.
			Essentially, we look at how many followers you have and how many
			people like, repin and comment your pins.</p>
	</div>
</div>

<footer></footer>

{% endblock %}
